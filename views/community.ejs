<%- include('partials/header') %>

<!-- Page Header -->
<section class="page-header">
    <div class="container">
        <h1 class="page-title"><span class="gradient-text">Community</span></h1>
        <p class="page-subtitle">Connect, Collaborate, and Grow Together</p>
        <p class="sanskrit-quote">"संगतिः संवर्धनं जनयति" - Community fosters growth</p>
        <div class="breadcrumb">
            <a href="/"><i class="fas fa-home"></i> Home</a>
            <span>/</span>
            <span>Community</span>
        </div>
    </div>
</section>

<!-- Community Stats -->
<section class="community-stats-section">
    <div class="container">
        <div class="stats-row">
            <div class="stat-item">
                <i class="fas fa-users"></i>
                <h3>5,000+</h3>
                <p>Community Members</p>
            </div>
            <div class="stat-item">
                <i class="fas fa-comments"></i>
                <h3>12,000+</h3>
                <p>Discussions</p>
            </div>
            <div class="stat-item">
                <i class="fas fa-lightbulb"></i>
                <h3>3,500+</h3>
                <p>Solutions Shared</p>
            </div>
            <div class="stat-item">
                <i class="fas fa-calendar-check"></i>
                <h3>50+</h3>
                <p>Events Hosted</p>
            </div>
        </div>
    </div>
</section>

<!-- Community Tabs -->
<section class="community-content-section">
    <div class="container">
        <div class="community-tabs">
            <button class="tab-btn active" data-tab="discussions">
                <i class="fas fa-comments"></i> Discussions
            </button>
            <button class="tab-btn" data-tab="events">
                <i class="fas fa-calendar"></i> Events
            </button>
            <button class="tab-btn" data-tab="resources">
                <i class="fas fa-book"></i> Resources
            </button>
            <button class="tab-btn" data-tab="contact">
                <i class="fas fa-envelope"></i> Contact Us
            </button>
        </div>

        <!-- Discussions Tab -->
        <div class="tab-content active" id="discussions">
            <div class="discussions-layout">
                <div class="discussions-sidebar">
                    <% const __counts = (typeof counts !== 'undefined' && counts) ? counts : {}; const __total = (typeof discussions !== 'undefined' && discussions) ? discussions.length : 0; %>
                    <h3>Categories</h3>
                    <ul class="discussion-categories">
                        <li class="active" data-category="all" role="tab" tabindex="0" aria-selected="true">
                            <i class="fas fa-layer-group"></i>
                            <span>All</span>
                            <span class="count"><%= __counts.all || __total %></span>
                        </li>
                        <li data-category="cybersecurity" role="tab" tabindex="0" aria-selected="false">
                            <i class="fas fa-shield-alt"></i>
                            <span>Cybersecurity</span>
                            <span class="count"><%= __counts['cybersecurity'] || 0 %></span>
                        </li>
                        <li data-category="iot-solutions" role="tab" tabindex="0" aria-selected="false">
                            <i class="fas fa-microchip"></i>
                            <span>IoT Solutions</span>
                            <span class="count"><%= __counts['iot-solutions'] || 0 %></span>
                        </li>
                        <li data-category="drone-tech" role="tab" tabindex="0" aria-selected="false">
                            <i class="fas fa-helicopter"></i>
                            <span>Drone Tech</span>
                            <span class="count"><%= __counts['drone-tech'] || 0 %></span>
                        </li>
                        <li data-category="cloud-computing" role="tab" tabindex="0" aria-selected="false">
                            <i class="fas fa-cloud"></i>
                            <span>Cloud Computing</span>
                            <span class="count"><%= __counts['cloud-computing'] || 0 %></span>
                        </li>
                        <li data-category="networking" role="tab" tabindex="0" aria-selected="false">
                            <i class="fas fa-network-wired"></i>
                            <span>Networking</span>
                            <span class="count"><%= __counts['networking'] || 0 %></span>
                        </li>
                        <li data-category="general" role="tab" tabindex="0" aria-selected="false">
                            <i class="fas fa-question-circle"></i>
                            <span>General</span>
                            <span class="count"><%= __counts['general'] || 0 %></span>
                        </li>
                    </ul>
                    <button class="btn btn-primary btn-block" id="newDiscussionBtn" onclick="openNewDiscussionModal()">
                        <i class="fas fa-plus"></i> New Discussion
                    </button>
                </div>

                <div class="discussions-main">
                    <div class="discussions-header">
                        <h2>Recent Discussions</h2>
                        <div class="discussion-filters">
                            <button class="filter-btn active">Latest</button>
                            <button class="filter-btn">Popular</button>
                            <button class="filter-btn">Unanswered</button>
                        </div>
                    </div>

                    <div class="discussion-list">
                        <% (discussions || []).forEach(function(disc){ %>
                        <div class="discussion-item" data-category="<%= disc.category %>" data-href="/community/discussion/<%= disc.id %>" role="button" tabindex="0">
                            <div class="discussion-avatar">
                                <i class="fas fa-user-circle"></i>
                            </div>
                            <div class="discussion-content">
                                <h3><a href="/community/discussion/<%= disc.id %>"><%= disc.title %></a></h3>
                                <p><%= disc.excerpt %></p>
                                <div class="discussion-meta">
                                    <span class="author"><i class="fas fa-user"></i> <%= disc.author %></span>
                                    <span class="time"><i class="fas fa-clock"></i> <%= new Date(disc.createdAt).toLocaleString('en-IN', {hour:'2-digit', minute:'2-digit'}) %></span>
                                    <span class="category"><i class="fas fa-tag"></i> <%= disc.category.replace(/-/g,' ') %></span>
                                </div>
                            </div>
                            <div class="discussion-stats">
                                <div class="stat">
                                    <i class="fas fa-comments"></i>
                                    <span><%= (disc.replies || []).length %></span>
                                </div>
                                <div class="stat">
                                    <i class="fas fa-eye"></i>
                                    <span><%= disc.views || 0 %></span>
                                </div>
                            </div>
                        </div>
                        <% }) %>
                    </div>
                </div>
            </div>
        </div>

        <!-- Events Tab -->
        <div class="tab-content" id="events">
            <div class="events-grid">
                <div class="event-card">
                    <div class="event-date">
                        <span class="day">15</span>
                        <span class="month">Nov</span>
                    </div>
                    <div class="event-content">
                        <h3>Cybersecurity Summit 2025</h3>
                        <p>Join industry leaders discussing the latest in cybersecurity threats and solutions</p>
                        <div class="event-details">
                            <span><i class="fas fa-map-marker-alt"></i> Online Webinar</span>
                            <span><i class="fas fa-clock"></i> 10:00 AM IST</span>
                        </div>
                        <button class="btn btn-primary btn-sm">
                            <i class="fas fa-calendar-plus"></i> Register Now
                        </button>
                    </div>
                </div>

                <div class="event-card">
                    <div class="event-date">
                        <span class="day">22</span>
                        <span class="month">Nov</span>
                    </div>
                    <div class="event-content">
                        <h3>IoT Workshop: Hands-on Training</h3>
                        <p>Practical workshop on building IoT solutions from scratch</p>
                        <div class="event-details">
                            <span><i class="fas fa-map-marker-alt"></i> Pune Tech Park</span>
                            <span><i class="fas fa-clock"></i> 9:00 AM - 5:00 PM</span>
                        </div>
                        <button class="btn btn-primary btn-sm">
                            <i class="fas fa-calendar-plus"></i> Register Now
                        </button>
                    </div>
                </div>

                <div class="event-card">
                    <div class="event-date">
                        <span class="day">30</span>
                        <span class="month">Nov</span>
                    </div>
                    <div class="event-content">
                        <h3>Drone Technology Showcase</h3>
                        <p>Live demonstration of commercial drone applications and use cases</p>
                        <div class="event-details">
                            <span><i class="fas fa-map-marker-alt"></i> Innovation Lab</span>
                            <span><i class="fas fa-clock"></i> 2:00 PM IST</span>
                        </div>
                        <button class="btn btn-primary btn-sm">
                            <i class="fas fa-calendar-plus"></i> Register Now
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Resources Tab -->
        <div class="tab-content" id="resources">
            <div class="resources-grid">
                <div class="resource-item">
                    <i class="fas fa-file-pdf"></i>
                    <h3>Cybersecurity Whitepaper</h3>
                    <p>Comprehensive guide to enterprise security</p>
                    <a href="#" class="btn btn-sm btn-outline">
                        <i class="fas fa-download"></i> Download
                    </a>
                </div>
                <div class="resource-item">
                    <i class="fas fa-file-code"></i>
                    <h3>IoT Development Kit</h3>
                    <p>Sample code and documentation</p>
                    <a href="#" class="btn btn-sm btn-outline">
                        <i class="fas fa-download"></i> Download
                    </a>
                </div>
                <div class="resource-item">
                    <i class="fas fa-video"></i>
                    <h3>Video Tutorials</h3>
                    <p>Step-by-step training videos</p>
                    <a href="#" class="btn btn-sm btn-outline">
                        <i class="fas fa-play"></i> Watch
                    </a>
                </div>
                <div class="resource-item">
                    <i class="fas fa-book"></i>
                    <h3>Technical Documentation</h3>
                    <p>Complete product documentation</p>
                    <a href="#" class="btn btn-sm btn-outline">
                        <i class="fas fa-book-open"></i> Read
                    </a>
                </div>
            </div>
        </div>

        <!-- Contact Tab -->
        <div class="tab-content" id="contact">
            <div class="contact-form-section">
                <div class="contact-form-container">
                    <h2>Get in Touch</h2>
                    <p class="sanskrit-quote">"संवादेन सर्वं साध्यते" - Everything is achievable through communication</p>
                    <form id="communityContactForm">
                        <div class="form-row">
                            <div class="form-group">
                                <label><i class="fas fa-user"></i> Full Name *</label>
                                <input type="text" name="name" required>
                            </div>
                            <div class="form-group">
                                <label><i class="fas fa-envelope"></i> Email *</label>
                                <input type="email" name="email" required>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label><i class="fas fa-phone"></i> Phone</label>
                                <input type="tel" name="phone">
                            </div>
                            <div class="form-group">
                                <label><i class="fas fa-building"></i> Company</label>
                                <input type="text" name="company">
                            </div>
                        </div>
                        <div class="form-group">
                            <label><i class="fas fa-tag"></i> Subject *</label>
                            <select name="subject" required>
                                <option value="">Select a subject</option>
                                <option value="general">General Inquiry</option>
                                <option value="partnership">Partnership</option>
                                <option value="support">Technical Support</option>
                                <option value="feedback">Feedback</option>
                                <option value="collaboration">Collaboration</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label><i class="fas fa-comment"></i> Message *</label>
                            <textarea name="message" rows="6" required></textarea>
                        </div>
                        <button type="submit" class="btn btn-primary btn-lg">
                            <i class="fas fa-paper-plane"></i> Send Message
                        </button>
                    </form>
                </div>
                <div class="contact-info-container">
                    <div class="contact-info-card">
                        <i class="fas fa-map-marker-alt"></i>
                        <h3>Visit Us</h3>
                        <p>Tech Park, Cyber City<br>Pune, Maharashtra 411014<br>India</p>
                    </div>
                    <div class="contact-info-card">
                        <i class="fas fa-phone"></i>
                        <h3>Call Us</h3>
                        <p>+91 20 1234 5678<br>+91 98765 43210<br>Mon-Sat: 9AM - 6PM</p>
                    </div>
                    <div class="contact-info-card">
                        <i class="fas fa-envelope"></i>
                        <h3>Email Us</h3>
                        <p>info@techsanrakshanam.in<br>support@techsanrakshanam.in<br>sales@techsanrakshanam.in</p>
                    </div>
                    <div class="contact-info-card">
                        <i class="fas fa-share-alt"></i>
                        <h3>Follow Us</h3>
                        <div class="social-links-vertical">
                            <a href="#"><i class="fab fa-linkedin"></i> LinkedIn</a>
                            <a href="#"><i class="fab fa-twitter"></i> Twitter</a>
                            <a href="#"><i class="fab fa-facebook"></i> Facebook</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- New Discussion Modal -->
<div id="newDiscussionModal" class="modal" style="display: none;">
    <div class="modal-content" style="max-width: 700px;">
        <div class="modal-header">
            <h2><i class="fas fa-plus-circle"></i> Start a New Discussion</h2>
            <button class="modal-close" onclick="closeNewDiscussionModal()">&times;</button>
        </div>
        <div class="modal-body">
            <form id="newDiscussionForm" onsubmit="submitNewDiscussion(event)">
                <div class="form-group">
                    <label for="discussionTitle">Discussion Title *</label>
                    <input type="text" id="discussionTitle" name="title" class="form-control" 
                           placeholder="What would you like to discuss?" required 
                           style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 1rem;">
                </div>
                <div class="form-group">
                    <label for="discussionCategory">Category *</label>
                    <select id="discussionCategory" name="category" class="form-control" required
                            style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 1rem;">
                        <option value="">Select a category...</option>
                        <option value="cybersecurity">Cybersecurity</option>
                        <option value="iot-solutions">IoT Solutions</option>
                        <option value="drone-tech">Drone Technology</option>
                        <option value="ai-ml">AI & Machine Learning</option>
                        <option value="blockchain">Blockchain</option>
                        <option value="networking">Networking</option>
                        <option value="general">General Discussion</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="discussionContent">Description *</label>
                    <textarea id="discussionContent" name="content" class="form-control" rows="8" required
                              placeholder="Provide details about your question or topic..."
                              style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 1rem; resize: vertical;"></textarea>
                    <small style="color: #666; font-size: 0.9rem;">Be specific and clear. Include relevant context and what you're trying to achieve.</small>
                </div>
                <div class="form-group">
                    <label for="discussionAuthor">Your Name *</label>
                    <input type="text" id="discussionAuthor" name="author" class="form-control" 
                           placeholder="Your name or username" required
                           style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 1rem;">
                </div>
                <div class="modal-footer" style="display: flex; gap: 15px; justify-content: flex-end; margin-top: 25px;">
                    <button type="button" class="btn btn-secondary" onclick="closeNewDiscussionModal()">
                        <i class="fas fa-times"></i> Cancel
                    </button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-paper-plane"></i> Post Discussion
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
function openNewDiscussionModal() {
    document.getElementById('newDiscussionModal').style.display = 'flex';
    document.body.style.overflow = 'hidden';
}

function closeNewDiscussionModal() {
    document.getElementById('newDiscussionModal').style.display = 'none';
    document.body.style.overflow = 'auto';
    document.getElementById('newDiscussionForm').reset();
}

async function submitNewDiscussion(event) {
    event.preventDefault();
    
    const form = event.target;
    const submitBtn = form.querySelector('button[type="submit"]');
    const originalText = submitBtn.innerHTML;
    
    // Disable button and show loading
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Posting...';
    
    const formData = {
        title: form.title.value,
        category: form.category.value,
        content: form.content.value,
        author: form.author.value,
        excerpt: form.content.value.substring(0, 150) + (form.content.value.length > 150 ? '...' : '')
    };
    
    try {
        const response = await fetch('/community/discussion/new', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(formData)
        });
        
        const result = await response.json();
        
        if (response.ok && result.success) {
            // Show success message
            alert('Discussion posted successfully!');
            closeNewDiscussionModal();
            // Redirect to the new discussion
            window.location.href = `/community/discussion/${result.id}`;
        } else {
            throw new Error(result.error || 'Failed to post discussion');
        }
    } catch (error) {
        console.error('Error posting discussion:', error);
        alert('Failed to post discussion. Please try again.');
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalText;
    }
}

// Close modal when clicking outside
document.addEventListener('DOMContentLoaded', function() {
    const modal = document.getElementById('newDiscussionModal');
    if (modal) {
        modal.addEventListener('click', function(e) {
            if (e.target === modal) {
                closeNewDiscussionModal();
            }
        });
    }
});
</script>

<style>
.modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.6);
    z-index: 9999;
    align-items: center;
    justify-content: center;
    padding: 20px;
    overflow-y: auto;
}

.modal-content {
    background: white;
    border-radius: 16px;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    width: 100%;
    max-height: 90vh;
    overflow-y: auto;
    animation: modalSlideIn 0.3s ease-out;
}

@keyframes modalSlideIn {
    from {
        opacity: 0;
        transform: translateY(-50px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.modal-header {
    padding: 25px 30px;
    border-bottom: 2px solid #f0f0f0;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.modal-header h2 {
    margin: 0;
    font-size: 1.75rem;
    color: #2c3e50;
}

.modal-header h2 i {
    color: var(--primary-color);
    margin-right: 10px;
}

.modal-close {
    background: none;
    border: none;
    font-size: 2rem;
    color: #999;
    cursor: pointer;
    line-height: 1;
    padding: 0;
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    transition: all 0.3s;
}

.modal-close:hover {
    background: #f5f5f5;
    color: #333;
}

.modal-body {
    padding: 30px;
}

.form-group {
    margin-bottom: 25px;
}

.form-group label {
    display: block;
    margin-bottom: 8px;
    font-weight: 600;
    color: #2c3e50;
    font-size: 1rem;
}

.form-control:focus {
    outline: none;
    border-color: var(--primary-color);
    box-shadow: 0 0 0 3px rgba(255, 107, 53, 0.1);
}

.btn-secondary {
    background: #6c757d;
    color: white;
}

.btn-secondary:hover {
    background: #5a6268;
}

@media (max-width: 768px) {
    .modal-content {
        max-width: 100%;
        margin: 20px;
    }
    
    .modal-header, .modal-body {
        padding: 20px;
    }
}
</style>

<%- include('partials/footer') %>
